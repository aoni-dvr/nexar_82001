#!/bin/sh
# Generates a small Makefile used in the root of the diag test
# directory, to allow make to be started from there.

# Usage
# $1 - ambacv src directory
# $2 - Diag test directory


test ! -r $2/Makefile -o -O $2/Makefile || exit 0
# Only overwrite automatically generated Makefiles
# (so we do not overwrite buildroot Makefile)
if test -e $2/Makefile && ! grep -q Automatically $2/Makefile
then
	exit 0
fi
echo "  GEN     $2/Makefile"

cat << EOF > $2/Makefile
# Automatically generated by $0: don't edit

SRC_ROOT = $1

DIAG_DIR := \$(SRC_ROOT)/tests
DIAG_SET := \$(patsubst \$(DIAG_DIR)/%.,%, \$(wildcard \$(DIAG_DIR)/*/.))

.PHONY: %-init %-build %-code %-code_orc %-data %-clean

%-init:
	\$(if \$(strip \$(wildcard \$(DIAG_DIR)/\$*)),,\$(error Cannot find test [\$*]))
	\$(if \$(strip \$(wildcard \$*)),\$(error Diag [\$*] exists!))
	@echo Init diag test \"\$*\" ...
	@mkdir -p \$*
	@ln -fs ../.target_make_env \$*
	@cd \$*; remoteconfig \$(DIAG_DIR)/\$* \$(OPTS) -opt amalgam_diag=0

%-build:
	\$(MAKE) -C \$* build

%-bin_link:
	\$(MAKE) -C \$* bin_link

%-code:
	\$(MAKE) -C \$* code

%-code_orc:
	\$(MAKE) -C \$* code_orc

%-data:
	\$(MAKE) -C \$* data

%-run:
	\$(MAKE) -C \$* run

%-check:
	\$(MAKE) -C \$* check

%-clean:
	rm -rf \$*

BUILD_ENV_FILE   := .target_make_env
ifneq ("\$(wildcard \$(BUILD_ENV_FILE))","")
MKENV := \$(shell cat \$(BUILD_ENV_FILE))
else
\$(error "Can't find proper build environment, exit")
endif

MKENV += AMBACV_KERNEL_SUPPORT=y
MKENV += BUILDDIR=\$(CURDIR)/rel

release:
	\$(MKENV) \$(MAKE) -C \$(SRC_ROOT)/arm_framework -f linux.mk framework cvtask

EOF
